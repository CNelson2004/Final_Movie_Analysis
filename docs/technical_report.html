<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.23">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Project Summary, Methodology, and Findings">

<title>Technical Report – Universal Studios Movie Analysis Package</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-1fe81d0376b2c50856e68e651e390326.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-dec27a635df3619fee3abd01ce5a42f4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed fullcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Universal Studios Movie Analysis Package</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./documentation.html"> 
<span class="menu-text">Documentation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./tutorial.html"> 
<span class="menu-text">Getting Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./technical_report.html" aria-current="page"> 
<span class="menu-text">Technical report</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Technical Report</h1>
</div>

<div>
  <div class="description">
    Project Summary, Methodology, and Findings
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="executive-summary" class="level2">
<h2 class="anchored" data-anchor-id="executive-summary">Executive Summary</h2>
<p><em>Project Objectives:</em> Identify the highest revenue movies by finding what features determine high grossing movies. In other words, how would I make a movie, and when would I release it in order to return the highest amount of revenue?</p>
<p><em>Key Findings:</em> None of the analyses done show anything statistically significant results when put in reference to the questions, though there are some small differences in movie revenue depending on various factors, (such as Season and Genre), these factors are not mentioned specifically since they are statistically irrelevant.</p>
<p><em>Actionable Recommendations:</em> Because there are no significant factors, more analysis is highly advised to reduce uncertainty. We suggest separating data (such as into season, movie type, etc) for a deeper analysis, which likely reduce the variation. Additionally, analysis identifying the high earning revenue movies and finding what they have in common could be used to see what influences revenue. The analysis did not show any statistically significant data, but some actions that might indicate a high revenue movie is a movie that appeals to everyone, is released in the summer, and has a high starting budget. Making a PG movie using Digital Animation in the genre of Adventure or Action, which appeals to those inside and outside the US, is anticipated to result in higher overall revenue.</p>
</section>
<section id="project-context" class="level2">
<h2 class="anchored" data-anchor-id="project-context">Project Context</h2>
<p><em>Motivation:</em> We want to know what movies have the highest revenue and see what could help maximize the revenue of a movie. Please note that this is with the belief that revenue for movies is an indicator of how good a movie is.</p>
<p><em>Success Criteria:</em> Identify distinct features that are important for and impact overall movie revenue.</p>
<p><em>Stakeholders:</em> This project has two interested parties. One is individuals who want to enjoy a good movie and do not want to pay for low quality entertainment, and the second is companies, (Business/Board of Trustees/Boss), who want to maximize the amount of revenue they earn when creating a movie.</p>
</section>
<section id="data-sources" class="level2">
<h2 class="anchored" data-anchor-id="data-sources">Data Sources</h2>
<ul>
<li><em>Primary dataset:</em>
<ul>
<li><a href="https://en.wikipedia.org/wiki/List_of_Universal_Pictures_films_(2020%E2%80%932029)">Universal Movies from 2020-2029</a> and <a href="https://en.wikipedia.org/wiki/List_of_Universal_Pictures_films_(2010%E2%80%932019)">Universal Movies from 2010-2019</a></li>
<li>Financial Data for movies: <a href="https://www.the-numbers.com/">The Numbers</a></li>
</ul></li>
<li><em>Supplementary data:</em> These were the only sites/sources used</li>
<li><em>Data access notes:</em> Wait five seconds between requests, all information is open access with no licenses needed.</li>
</ul>
</section>
<section id="methodology" class="level2">
<h2 class="anchored" data-anchor-id="methodology">Methodology</h2>
<ol type="1">
<li><p><em>Data acquisition:</em> Used common web scraping techniques to obtain data from Wikipedia and The Numbers using the libraries: requests, beautiful soup, regex, and pandas. Specifically, our function <code>data_creation</code> uses the init function for both requests and beautiful soup, <code>read_html</code> from pandas, <code>sub</code>, <code>match</code> from regex, <code>get</code> from requests, and <code>find</code> from beautiful soup.</p></li>
<li><p><em>Cleaning pipeline:</em></p></li>
</ol>
<ul>
<li>Changed Release Date into a datetime object.</li>
<li>Changed all revenue numbers from strings containing $ to proper integers.</li>
<li>Changed runtime from a string to an integer</li>
<li>Changed all None values to np.Nan</li>
<li>Removed all extraneous information, specifically
<ul>
<li>Who released the movie and what type of release it was (for both video and theater release date)</li>
<li>Percentage of total gross for opening weekend</li>
<li>Production budget as related to worldwide box office</li>
<li>MPAA Rating specifics</li>
</ul></li>
<li>Created a profits column by taking Total Box Office Revenue - Budget</li>
<li>Also created a Year, Month, and Season column based upon release date</li>
<li>This was validated by checking that all columns were of specified types and manually viewing the dataset, and all was as expected</li>
<li>A separated csv was created for Machine Learning Analysis wherein the target, Total Box Office Revenue, was analyzed as a log of the original target due to the skewness of the target data, this separate csv, <code>ml_movie_data.csv</code>, also removes all non-numeric columns.</li>
<li><code>ml_movie_data.csv</code> is the transformed version of <code>movie_data.csv</code></li>
<li>This was validated by checking the new transformed column and csv as a whole.</li>
</ul>
<ol start="3" type="1">
<li><em>Analysis workflow:</em></li>
</ol>
<ul>
<li>Correlate all the data to see what has an effect on income</li>
<li>Find the NAs for reference</li>
<li>Plot the money against one another to check for anomalies</li>
<li>Find the average revenue for each year and then plot it for clearer visuals</li>
<li>Find the statistics for some of the means</li>
<li>Plot the categorical data with regards to the Inflation Adjusted Domestic Revenue</li>
</ul>
<p>“We used some basic analysis such as correlation, plots to visualize it (mostly line plots but some box plots for categorical data). This required only a few changes such as adding a column for year or doing basic math, mostly wit dates, to get usable numbers for plots and correlation. There are some NAs in the data set, around 60 to 70 for each column. The highest one was 146 but that was Franchise which wasn’t really used in any analysis”</p>
<ol start="4" type="1">
<li><em>Tooling:</em></li>
</ol>
<ul>
<li>Packages: The packages used were:
<ul>
<li>bs4</li>
<li>ipykernel</li>
<li>lxml</li>
<li>matplotlib</li>
<li>numpy</li>
<li>pandas</li>
<li>requests</li>
<li>scikit-learn</li>
<li>shap</li>
</ul></li>
<li>Environments: The virtual environment UV was used for this project with Python 3.13.</li>
<li>Reproducibility Steps: Run <code>totality()</code> to reproduce our dataset, results, and interpretation, for more details see the <a href="./tutorial.html">tutorial</a></li>
</ul>
</section>
<section id="results-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="results-diagnostics">Results &amp; Diagnostics</h2>
<p><em>Main Metrics:</em></p>
<p>The main metrics for the plots and data of importance are as follows:</p>
<pre><code>Total Box Office Revenue:
    mean = 1.9 e^8 (190 million US dollars)
    sd = 3.0 e^8 (300 million US dollars) 
    median = 8.37 e^7 (83 million US dollars)

Season of Release:
    Fall:   mean = 1.14 e^8 (114 million US dollars),
            sd = 1.47 e^8 (147 million US dollars)
            median = 7.73 e^7 (77 million US dollars)

    Spring: mean = 2.24 e^8 (224 million US dollars),
            sd = 3.96 e^8 (396 million US dollars)
            median = 6.44 e^7 (64 million US dollars)

    Summer: mean = 3.19 e^8 (319 million US dollars),
            sd = 4.20 e^8 (420 million US dollars)
            median = 1.37 e^8 (137 million US dollars)

    Winter: mean = 1.52 e^8 (152 million US dollars),
            sd = 1.58 e^8 (158 million US dollars)
            median = 9.62 e^7 (96 million US dollars)

Genre:
    The highest means are in 'Musicals', 'Action', 'Adventure' with means, sd, and median of:
    Action:     mean = 5.36 e^8 (536 million US dollars),
                sd = 5.13 e^8 (513 million US dollars)
                median = 3.34 e^8 (334 million US dollars)

    Adventure:  mean = 4.41 e^8 (441 million US dollars),
                sd = 4.26 e^8 (426 million US dollars)
                median = 2.52 e^8 (252 million US dollars)

    Musical:    mean = 3.17 e^8 (317 million US dollars),
                sd = 3.14 e^8 (314 million US dollars)
                median = 3.96 e^8 (396 million US dollars)

Movie Rating: 
    PG: mean = 2.84 e^8 (284 million US dollars),
        sd = 3.70 e^8 (370 million US dollars)
        median = 1.25 e^8 (125 million US dollars)

    R:  mean = 9.67 e^7 (97 million US dollars),
        sd = 1.42 e^8 (142 million US dollars)
        median = 5.60 e^7 (56 million US dollars)

Production Method:
    Animation/Live Action:  mean = 3.05 e^8 (305 million US dollars),
                            sd = 4.05 e^8 (405 million US dollars)
                            median = 2.17 e^8 (217 million US dollars)

    Digital Animation:      mean = 4.98 e^8 (498 million US dollars),
                            sd = 4.22 e^8 (422 million US dollars)
                            median = 3.70 e^8 (370 million US dollars)

    Live Action:            mean = 1.54 e^8 (154 million US dollars)
                            sd = 2.59 e^8 (259 million US dollars)
                            median = 7.70 e^7 (77 million US dollars)

    Stop-Motion Animation:  mean = 9.47 e^7 (95 million US dollars)
                            sd = 2.43 e^7 (24 million US dollars)
                            median = 9.47 e^7 (95 million US dollars)</code></pre>
<p>Statistical Significance of the following features:</p>
<pre><code>Season (Relation to Total Box Office Revenue)
    Overall F-value = 4.81
    Overall p-value = 0.0030
    
Significance Between Groups:
    Fall vs Spring:   p = 0.4247
    Fall vs Summer:   p = 0.0120
    Fall vs Winter:   p = 0.5921
    Spring vs Summer: p = 0.7339
    Spring vs Winter: p = 0.7562
    Summer vs Winter: p = 0.0636


Genre (Relation to Total Box Office Revenue)
    Overall F = 7.77
    Overall p = 2.93e-10

Significance Between Groups:
    Action vs Adventure:           p = 0.9999
    Action vs Musical:             p = 0.9470
    Adventure vs Musical:          p = 0.998173


Movie Rating (Relation to Total Box Office Revenue)
    Overall F = 9.78
    Overall p = 0.000093

Significance Between Groups:
    Not Rated vs PG: p = NaN
    Not Rated vs R:  p = NaN
    PG vs R:         p = 0.000024


Production Method (Relation to Total Box Office Revenue)
    Overall F = 9.03
    Overall p = 0.000013

Significance Between Groups:
    Animation/Live Action vs Digital Animation: p = 0.7827
    Animation/Live Action vs Live Action:       p = 0.8409
    Animation/Live Action vs Stop-Motion:       p = 0.6803
    Digital Animation vs Live Action:           p = 0.0093
    Digital Animation vs Stop-Motion:           p = 0.0023
    Live Action vs Stop-Motion:                 p = 0.2194</code></pre>
<p><em>Charts:</em> The following graph shows the differences in revenue and their correlation, (and why international matters to total so much). <img src="revenue_by_year.png" class="img-fluid" alt="average yearly revenue"></p>
<p>The following charts show the median and other ranges regarding the values described above and how they compare to each other: <img src="revenue_by_season.png" class="img-fluid" alt="revenue by season"> <img src="revenue_by_genre.png" class="img-fluid" alt="revenue by genre"> <img src="revenue_by_rating.png" class="img-fluid" alt="revenue by rating"> <img src="revenue_by_production_method.png" class="img-fluid" alt="revenue by method"></p>
<p><em>Model Diagnostics:</em> We chose not to create a prediction model because no statistically significant variables were identified, and thus have no model diagnostics.</p>
</section>
<section id="discussion-next-steps" class="level2">
<h2 class="anchored" data-anchor-id="discussion-next-steps">Discussion &amp; Next Steps</h2>
<p><em>Results:</em> There were no statistically significant variables because the variance was so high. There are some factors that appear to have some influence such as season of release, genre, and rating (R, PG, G) but further analysis could reveal more influence if variance was reduced.</p>
<p><em>Limitations:</em> The categorical and numerical analysis for correlation can’t show causation so we don’t know if adjusting one will directly influence the other. Additionally, none of the results shown significance, this means that the variance of revenue in any of our analyses is not different form the average mean.</p>
<p><em>Open Questions:</em> 1. If you separate things further (year of production, season of production, genre, etc.) dose it tell a clearer story about the data? 2. Are movie ratings related to the revenue earned for that movie? 3. Are there other factors that influence revenue? (storyline, plot twists, etc) 4. Do outliers (very high or very low revenue movies) have common factors?</p>
<p><em>Future Experiments:</em> In order to reduce the amount of variance it would be smart to separate data more, an example might be only action movies in winter compared to adventure movies in winter. This would hopefully reduce the variance and create a more accurate analysis as well as show any influence between variables, for example if R movies earning less revenue because most of them were released in winter, then an analysis of movie ratings for these movies would be informative as to what watchers value and therefore what you could charge more for.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/cnelson2004\.github\.io\/Final_Movie_Analysis\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>